# Section 3.

### 메모리에 유저 정보를 저장하는 첫 번째 방법 
- UserDetailsManager를 extends한 InMemoryUserDetailsManager클래스를 정의해주면 된다.
```java
@Bean
    public InMemoryUserDetailsManager userDetailsService(){
        UserDetails admin = User.withDefaultPasswordEncoder()
                .username("admin")
                .password("12345")
                .authorities("admin")
                .build();

        UserDetails user = User.withDefaultPasswordEncoder()
                .username("user")
                .password("12345")
                .authorities("read")
                .build();

        return new InMemoryUserDetailsManager(admin,user);
    }
```
위와 같은 코드에서 User.build()를 호출하면 유저의 세부사항이 담긴 User 객체를 생성할 수 있고, 이렇게 생성한 객체를
InMemoryUserDetailsManager의 생성자에 인자로 집어넣어 메모리에 저장할 수 있는것이다.

```java
public InMemoryUserDetailsManager(Collection<UserDetails> users) {
        Iterator var2 = users.iterator();

        while(var2.hasNext()) {
            UserDetails user = (UserDetails)var2.next();
            this.createUser(user);  // <---- 유저 생성
        }

    }
```

```java
public void createUser(UserDetails user) {
        Assert.isTrue(!this.userExists(user.getUsername()), "user should not exist");
        this.users.put(user.getUsername().toLowerCase(), new MutableUser(user)); <-- put 메소드를 통해 저장
    }
```

- 위의 실제 코드를 보면 다음과 같이 넘어온 유저의 정보를 저장하는 것을 확인할 수 있다.

### 메모리에 유저를 저장하는 두 번째 방법
- 두 번째 방법은 withDefaultPasswordEncoder()를 사용하지 않는다.
- 그 대신 Bean으로 NoOpPasswordEncoder를 등록해서 사용하는데, 이 방식은 비밀번호를 인코딩 하지 않고 String 그대로 저장하겠다는 의미이다.
- NoOpPasswordEncoder를 Bean으로 등록하면 모든 유저를 NoOpPasswordEncoder 방식으로 저장하겠다고 해석이된다.

### UserDetailsService란 무엇일까
- 유저 정보를 가져오는 역할을 한다.
- UserDetails라는 인터페이스를 구현한다.
- LoadUserByUserName이라는 추상메소드가 UserDetils 인터페이스에 정의돼있다.
- LoadUserByUserName메소드는 UserName을 기반으로 저장소에서 유저 정보를 찾아온다.
- 비밀번호로 유저 정보를 찾지 않는 이유는 비밀번호가 서버에 유출될 가능성이 있기 때문이다.

### UserDetailsManager란 무엇일까
- 유저를 새롭게 만들거나 업데이트, 삭제하는 역할을 한다.
- 마찬가지로 UserDetails라는 인터페이스를 구현한다.
- LoadUserByUserName도 정의돼있다.
- 스프링 시큐리티 팀에서 구현한 샘플클래스가 있다.
  - InMemoryUserDetailsManager, JdbcUserDetailsManager, LdapUserDetailsManager가 존재한다.
  - 데이터베이스에서 유저정보를 가져올땐 JdbcUserDetailsManager를 사용하면 된다.
  - Ldap서버에 유저 정보를 저장했다면 LdapUserDetailsManager를 사용하면 된다.
 
### 가져온 정보는 어떤 형식으로 저장될까
- UserDetails는 유저의 정보를 저장할 수 있는 인터페이스이다.
- UserDetails를 구현한 User 클래스에 가져온 유저의 정보를 저장한다.

### 정리
- ProviderManager에 Athentication 객체 즉 입력받은 유저의 정보가 넘어온다.
- ProviderManager는 가능한 모든 Authentication Provider에 유저의 정보를 넘긴다.
- DaoAuthenticationProvider에 유저 정보가 넘어가고 InMemoryUserManager 내부의 LoadUserByUserName 메소드가 실행된다.
- UserName을 기반으로 유저 정보가 찾아지고
```java
public UserDetails loadUserByUsername(String username) throws UsernameNotFoundException {
        UserDetails user = (UserDetails)this.users.get(username.toLowerCase());
        if (user == null) {
            throw new UsernameNotFoundException(username);
        } else {
            return new User(user.getUsername(), user.getPassword(), user.isEnabled(), user.isAccountNonExpired(), user.isCredentialsNonExpired(), user.isAccountNonLocked(), user.getAuthorities());
        }
    }
```
- 다음과 같이 찾아진 유저 정보가 있다면 User 객체에 해당 정보를 담아 반환한다.
